---
- name: Deploy Grafana Dashboard as Code
  hosts: localhost
  gather_facts: false
  vars:
    stack_slug: "{{ stack_slug }}"
    grafana_api_key: "{{ grafana_api_key }}"

  tasks:
    - name: dashboard as code
      grafana.grafana.dashboard:
        dashboard:
          id: null
          uid: "ascode"
          title: "as-code dashboard"
          tags: ["banking", "transactions", "ledger", "payroll"]
          timezone: "browser"
          schemaVersion: 16
          version: 0
          refresh: "5s"
          panels:
            - id: 1
              gridPos:
                h: 8
                w: 12
                x: 0
                y: 0
              type: "graph"
              title: "Transaction Volume"
              targets:
                - refId: "A"
                  target: "transactions.count"
              xaxis:
                show: true
                mode: "time"
              yaxes:
                - label: "Transactions"
                  show: true
                - show: true
            - id: 2
              gridPos:
                h: 8
                w: 12
                x: 12
                y: 0
              type: "stat"
              title: "Total Balance"
              targets:
                - refId: "A"
                  target: "ledger.balance"
              options:
                graphMode: "area"
                colorMode: "value"
                justifyMode: "auto"
                textMode: "auto"
              fieldConfig:
                defaults:
                  unit: "currencyUSD"
                  decimals: 2
            - id: 3
              gridPos:
                h: 8
                w: 12
                x: 0
                y: 8
              type: "table"
              title: "Recent Transactions"
              targets:
                - refId: "A"
                  target: "transactions.recent"
              options:
                showHeader: true
              fieldConfig:
                defaults:
                  custom:
                    align: "auto"
                    displayMode: "auto"
            - id: 4
              gridPos:
                h: 8
                w: 12
                x: 12
                y: 8
              type: "piechart"
              title: "Transaction Types"
              targets:
                - refId: "A"
                  target: "transactions.by_type"
              options:
                legend:
                  displayMode: "list"
                  placement: "bottom"
                pieType: "pie"
            - id: 5
              gridPos:
                h: 8
                w: 8
                x: 0
                y: 16
              type: "stat"
              title: "Debit Total"
              targets:
                - refId: "A"
                  target: "ledger.debit_total"
              options:
                colorMode: "value"
                graphMode: "area"
              fieldConfig:
                defaults:
                  unit: "currencyUSD"
                  color:
                    mode: "thresholds"
                  thresholds:
                    mode: "absolute"
                    steps:
                      - value: null
                        color: "red"
            - id: 6
              gridPos:
                h: 8
                w: 8
                x: 8
                y: 16
              type: "stat"
              title: "Credit Total"
              targets:
                - refId: "A"
                  target: "ledger.credit_total"
              options:
                colorMode: "value"
                graphMode: "area"
              fieldConfig:
                defaults:
                  unit: "currencyUSD"
                  color:
                    mode: "thresholds"
                  thresholds:
                    mode: "absolute"
                    steps:
                      - value: null
                        color: "green"
            - id: 7
              gridPos:
                h: 8
                w: 8
                x: 16
                y: 16
              type: "stat"
              title: "Payroll Processed"
              targets:
                - refId: "A"
                  target: "payroll.total"
              options:
                colorMode: "value"
                graphMode: "area"
              fieldConfig:
                defaults:
                  unit: "currencyUSD"
                  color:
                    mode: "thresholds"
                  thresholds:
                    mode: "absolute"
                    steps:
                      - value: null
                        color: "blue"
            - id: 8
              gridPos:
                h: 8
                w: 24
                x: 0
                y: 24
              type: "graph"
              title: "Assets Over Time"
              targets:
                - refId: "A"
                  target: "assets.total"
              xaxis:
                show: true
                mode: "time"
              yaxes:
                - label: "Assets (USD)"
                  show: true
                  format: "currencyUSD"
                - show: true
              lines: true
              fill: 1
              linewidth: 2
              points: false
              pointradius: 2
          time:
            from: "now-6h"
            to: "now"
          timepicker:
            refresh_intervals: ["5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h", "2h", "1d"]
        stack_slug: "{{ stack_slug }}"
        grafana_api_key: "{{ grafana_api_key }}"
        state: present
