{
  "dashboard": {
    "title": "User Activity Dashboard",
    "panels": [
      {
        "title": "Daily Active Users (DAU)",
        "type": "stat",
        "targets": [
          {
            "expr": "count(count_over_time(user_action_total[24h]))",
            "refId": "C"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {
                  "value": null,
                  "color": "red"
                },
                {
                  "value": 5000,
                  "color": "yellow"
                },
                {
                  "value": 10000,
                  "color": "green"
                }
              ]
            }
          }
        },
        "alert": {
          "conditions": [
            {
              "evaluator": {
                "params": [],
                "type": "lt"
              },
              "operator": {
                "type": "and"
              },
              "query": {
                "params": ["C", "5m", "now"]
              },
              "reducer": {
                "params": [],
                "type": "last"
              },
              "type": "query"
            }
          ],
          "executionErrorState": "alerting",
          "for": "5m",
          "frequency": "1m",
          "handler": 1,
          "name": "DAU Drop Alert",
          "noDataState": "no_value",
          "notifications": []
        }
      },
      {
        "title": "Weekly Active Users (WAU)",
        "type": "stat",
        "targets": [
          {
            "expr": "count(count_over_time(user_action_total[7d]))",
            "refId": "D"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {
                  "value": null,
                  "color": "green"
                }
              ]
            }
          }
        }
      },
      {
        "title": "DAU/WAU Stickiness Ratio",
        "type": "gauge",
        "targets": [
          {
            "expr": "SELECT\n  COUNT(DISTINCT CASE WHEN timestamp >= NOW() - INTERVAL '1 day' THEN user_id END)::float\n  /\n  COUNT(DISTINCT CASE WHEN timestamp >= NOW() - INTERVAL '7 days' THEN user_id END)\nAS dau_wau_ratio\nFROM events;",
            "refId": "A",
            "instant": true
          }
        ],
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {
                  "value": null,
                  "color": "red"
                },
                {
                  "value": 0.3,
                  "color": "yellow"
                },
                {
                  "value": 0.5,
                  "color": "green"
                }
              ]
            }
          }
        },
        "alert": {
          "conditions": [
            {
              "evaluator": {
                "params": [0.25],
                "type": "lt"
              },
              "operator": {
                "type": "and"
              },
              "query": {
                "params": ["A", "5m", "now"]
              },
              "reducer": {
                "params": [],
                "type": "last"
              },
              "type": "query"
            }
          ],
          "executionErrorState": "alerting",
          "for": "5m",
          "frequency": "1m",
          "handler": 1,
          "name": "Low Stickiness Alert",
          "noDataState": "no_value",
          "notifications": []
        }
      },
      {
        "title": "User Actions",
        "type": "stat",
        "targets": [
          {
            "expr": "count(count_over_time(user_action_total[24h])) / count(count_over_time(user_action_total[7d]))",
            "refId": "B"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {
                  "value": null,
                  "color": "green"
                }
              ]
            }
          }
        }
      },
      {
        "title": "Trendline: Active Users Over Time",
        "type": "timeseries",
        "targets": [
          {
            "expr": "count(count_over_time(user_action_total[24h]))",
            "refId": "E",
            "legendFormat": "DAU"
          },
          {
            "expr": "count(count_over_time(user_action_total[7d]))",
            "refId": "F",
            "legendFormat": "WAU"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "custom": {
              "line": {
                "width": 2
              }
            }
          }
        }
      }
    ]
  }
}
